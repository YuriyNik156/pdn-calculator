# Микросервис для расчёта платежной долговой нагрузки (PDN Calculator)

**Описание**

Сервис предназначен для расчёта платёжной долговой нагрузки (PDN) для физических лиц.
Он предоставляет REST API, позволяющий рассчитать PDN в двух режимах — base и stress, с учётом кредитов, карт, 
доходов и параметров клиента.
Проект создаётся как тестовое задание и демонстрирует навыки работы с FastAPI, Pydantic, Docker и pytest.

---

**Сервис поддерживает:**

* строгую валидацию входных данных;
* нормализацию периодичности платежей;
* учёт кредитных карт с минимальным платёжным порогом;
* аудит запросов с маскированием персональных данных;
* автоматическую документацию API (OpenAPI/Swagger);
* базовые тесты и структуру проекта, готовую для расширения.

---

## Основные возможности

**Расчёт PDN**

* POST /pdn/calc — расчёт PDN для физических лиц (subject_type=individual)
* Поддержка режимов:
    * base — базовый расчёт
    * stress — стресс-сценарий (при ухудшенных условиях)

* Валидация и нормализация данных
    * Проверка типов и обязательных полей (через Pydantic)
    * Приведение периодичности платежей к месячной
    * Поддержка минимальных платежей для кредитных карт
* Результат расчёта
    * calc_version, risk_band, breakdown, meta.ts

    * Пример:

    ```bash
    {
      "calc_version": "1.0.0",
      "risk_band": "medium",
      "breakdown": {"pdn_ratio": 0.25},
      "meta": {"ts": "2025-10-20T10:00:00Z"}
    }
   ```

* Логирование с маскированием PII
    * Аудит всех запросов и ответов в консоль или файл
    * Персональные данные заменяются символами ***

* Документация API
    * Автоматически генерируется по адресу /docs
        
---

## Архитектура проекта

* Backend — FastAPI (Python 3.10+)
* Валидация данных — Pydantic
* Тестирование — pytest
* Контейнеризация — Docker
* (опционально) Redis/Postgres — в качестве заглушек для будущих этапов

---

## Модель данных (вход/выход)

**PDNRequest**

  * subject_type — тип субъекта (только individual)
  * mode — режим (base или stress)
  * income — ежемесячный доход
  * loans — список кредитов, каждый с полями:
    * type — loan или credit_card
    * payment — сумма платежа
    * limit — кредитный лимит (для карт)
    * period — периодичность (monthly, weekly, quarterly и т.д.)

**PDNResponse**

* calc_version
* risk_band
* breakdown — детали расчёта (PDN, общая сумма, количество кредитов)
* meta — служебная информация (timestamp)

---

## Установка и запуск

**1. Клонировать репозиторий:**

    ```bash
    git clone https://github.com/ваш_пользователь/pdn_calculator.git
    cd pdn_calculator
    ```

**2. Создать виртуальное окружение и установить зависимости:**

    ```bash
    python -m venv venv
    source venv/bin/activate       # Linux/macOS
    venv\Scripts\activate          # Windows
    pip install -r requirements.txt
    ```

**3. Запустить приложение:**

    ```bash
    uvicorn app.main:app --reload
    ```

**4. Открыть документацию Swagger:**

    ```bash
    http://127.0.0.1:8000/docs
    ```

---

## Пример запроса

**POST /pdn/calc**

    ```bash
    {
      "subject_type": "individual",
      "mode": "base",
      "income": 80000,
      "loans": [
        {"type": "loan", "payment": 15000, "period": "monthly"},
        {"type": "credit_card", "limit": 100000, "payment": 0, "period": "monthly"}
      ]
    }
    ```

**Response:**

    ```bash
    {
      "calc_version": "1.0.0",
      "risk_band": "medium",
      "breakdown": {
        "total_payments": 20000,
        "pdn_ratio": 0.25
      },
      "meta": {"ts": "2025-10-20T10:00:00Z"}
    }
    ```

---

## Тестирование

**Запуск тестов:**

    ```bash
    pytest -v
    ```

**Планируется покрытие тестами:**

* корректность API /pdn/calc;
* валидация данных;
* расчёт PDN в разных режимах;
* обработка ошибок.

---

