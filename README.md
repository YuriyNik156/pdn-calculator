# Микросервис расчёта платежной долговой нагрузки (PDN Calculator)

**Описание**

Микросервис предназначен для расчёта платёжной долговой нагрузки (PDN) физических лиц,
с возможностью расширения под бизнес-сегмент. Поддерживает несколько сценариев расчёта,
строгую валидацию входных данных, аудит, версионирование и подготовку к конвертации валют.

---

**Сервис поддерживает:**

* Расчёт ПДН физических лиц (режимы base, stress, target)  
* Валидацию и нормализацию входных данных  
* Учёт кредитных карт (min_payment_rate)  
* Аудит запросов с маскированием персональных данных  
* Версионирование формулы (`calc_version`)  
* Подготовку к поддержке FX-конверсии и бизнес-сценариев (в разработке) 

---

## Технологический стек

* Язык программирования: Python 3.10+
* Фреймворк: FastAPI
* Валидация данных: Pydantic
* Логирование и аудит: logging, custom middleware
* Контейнеризация: Docker
* Конфигурация: python-dotenv (.env)
* Тестирование: pytest
* Контроль версий: git, GitHub

---

## Основные возможности

**Расчёт PDN**

* POST /pdn/calc — расчёт PDN для физических лиц (subject_type=individual)
* Поддержка режимов:
    * base — базовый расчёт
    * stress — стресс-сценарий при ухудшенных условиях
    * target — с учётом рефинансирования

* Валидация и нормализация данных
    * Проверка типов и обязательных полей (через Pydantic)
    * Приведение периодичности платежей к месячной
    * Поддержка минимальных платежей для кредитных карт
    * 
* Результат расчёта
    * calc_version, risk_band, breakdown, meta.ts

    * Пример:

    ```bash
    {
      "calc_version": "1.0.0",
      "risk_band": "medium",
      "breakdown": {"pdn_ratio": 0.25},
      "meta": {"ts": "2025-10-20T10:00:00Z"}
    }
   ```

* Логирование с маскированием PII
    * Аудит всех запросов и ответов в консоль или файл
    * Персональные данные заменяются символами ***

* Документация API
    * Автоматически генерируется по адресу /docs
        
---

## Архитектура проекта

* Backend — FastAPI (Python 3.10+)
* Валидация данных — Pydantic
* Тестирование — pytest
* Контейнеризация — Docker
* (опционально) Redis/Postgres — в качестве заглушек для будущих этапов

---

## Модель данных (вход/выход)

**PDNRequest**

  * subject_type — тип субъекта (individual)
  * mode — режим (base, stress, target)
  * income — ежемесячный доход
  * obligations — список обязательств, каждое с полями:
    * type — loan, credit_card, alimony и др.
    * payment — сумма платежа
    * balance — задолженность (для карт)
    * period — периодичность (monthly, weekly, quarterly и т.д.)

**PDNResponse**

* calc_version — версия формулы расчёта
* risk_band — пороговый индикатор (LOW, MID, HIGH)
* breakdown — детали расчёта
* meta — служебная информация (timestamp, request_id)

---

## API эндпоинты

| Метод | URL | Назначение |
|-------|-----|-------------|
| POST | `/pdn/calc` | Расчёт ПДН для физлиц |
| GET  | `/pdn/config` | Получение конфигурации и версий формулы |
| (опционально) POST | `/pdn/calc/business` | Расчёт для компаний (в разработке) |

---

## Установка и запуск

**1. Клонировать репозиторий:**

    ```bash
    git clone https://github.com/ваш_пользователь/pdn_calculator.git
    cd pdn_calculator
    ```

**2. Создать виртуальное окружение и установить зависимости:**

    ```bash
    python -m venv venv
    source venv/bin/activate       # Linux/macOS
    venv\Scripts\activate          # Windows
    pip install -r requirements.txt
    ```

**3. Запустить приложение:**

    ```bash
    uvicorn app.main:app --reload
    ```

**4. Открыть документацию Swagger:**

    ```bash
    http://127.0.0.1:8000/docs
    ```

---

## Пример запроса

**POST /pdn/calc**

    ```bash
    {
      "subject_type": "individual",
      "mode": "base",
      "income": 80000,
      "loans": [
        {"type": "loan", "payment": 15000, "period": "monthly"},
        {"type": "credit_card", "limit": 100000, "payment": 0, "period": "monthly"}
      ]
    }
    ```

**Response:**

    ```bash
    {
      "calc_version": "1.0.0",
      "risk_band": "medium",
      "breakdown": {
        "total_payments": 20000,
        "pdn_ratio": 0.25
      },
      "meta": {"ts": "2025-10-20T10:00:00Z"}
    }
    ```

---

## Тестирование

**Запуск тестов:**

    ```bash
    pytest -v
    ```

**Покрытие тестами:**

* корректность API /pdn/calc;
* валидация данных;
* расчёт PDN в разных режимах;
* обработка ошибок.

---

## Структура проекта

    ```bash
    pdn_calculator/
    ├── app/
    │   ├── __init__.py
    │   ├── main.py             # Точка входа FastAPI
    │   ├── models.py           # Pydantic-схемы (Request/Response)
    │   ├── services.py         # Логика расчёта PDN
    │   ├── security.py         # Маскирование
    │   ├── auth.py             # Авторизация
    │   ├── logger.py           # Настройка логирования
    │   ├── config.py           # Конфигурация
    │   ├── audit.py            # Аудит запросов
    │   ├── docs                # Документация
    │   └── static
    │       └── index.html      # HTML-страница
    ├── tests/
    │   ├── __init__.py
    │   ├── test_services.py    # Тесты эндпоинта и логики
    │   ├── test_load.py        # Нагрузочные тесты
    │   └── test_api.py         # api-тесты
    │
    ├── Dockerfile
    ├── requirements.txt
    └── README.md
    ```

---

## Этапы разработки

Этап 0: анализ ТЗ, выделение MVP, создание репозитория, подготовка структуры проекта
Этап 1: реализация /pdn/calc, Pydantic-схемы, базовая логика расчёта
Этап 2: аудит и маскирование PII, нормализация периодичности, тесты, документация
Этап 3: Dockerfile, рефакторинг и финальное ревью кода

---

## Планы развития

* Поддержка расчёта для бизнеса (DCR, pdn_business)
* Конвертация валют с FxService
* Подключение PostgreSQL для истории запросов и конфигурации
* CI/CD, unit и контракт-тесты, нагрузочное тестирование

---

## Зависимости

Основные библиотеки:

* fastapi
* uvicorn
* pydantic
* pytest
* python-dotenv

Полный список находится в requirements.txt.

---

## Лицензия

Проект распространяется под лицензией MIT License.