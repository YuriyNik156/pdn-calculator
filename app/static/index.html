<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>PDN Calculator MVP</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        label { display: block; margin-top: 10px; }
        input { margin-top: 2px; padding: 5px; width: 200px; }
        button { margin-top: 10px; padding: 5px 10px; }
        .obligation { margin-bottom: 5px; }
        .result { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
        .risk-LOW { color: green; }
        .risk-MID { color: orange; }
        .risk-HIGH { color: red; }
    </style>
</head>
<body>

<h2>PDN Calculator MVP</h2>

<form id="pdnForm">
    <label>
        Доход (RUB):
        <input type="number" id="incomeAmount" required min="0" step="any" value="100000">
    </label>

    <label>
        Период (месяцев):
        <input type="number" id="periodMonths" required min="1" value="6">
    </label>

    <div id="obligationsContainer">
        <h4>Обязательства</h4>
        <!-- Динамические обязательства добавятся сюда -->
    </div>
    <button type="button" id="addObligationBtn">Добавить обязательство</button>

    <h4>Сценарий</h4>
    <label>
        Mode:
        <select id="scenarioMode">
            <option value="base">base</option>
            <option value="stress">stress</option>
            <option value="target">target</option>
        </select>
    </label>
    <label>
        Шок дохода (%):
        <input type="number" id="incomeShock" step="0.01" value="0">
    </label>
    <label>
        Шок платежей (%):
        <input type="number" id="paymentShock" step="0.01" value="0">
    </label>

    <button type="submit">Рассчитать PDN</button>
</form>

<div id="result" class="result"></div>

<script>
let obligationCount = 0;

function addObligation() {
    obligationCount++;
    const container = document.getElementById('obligationsContainer');
    const div = document.createElement('div');
    div.className = 'obligation';
    div.innerHTML = `
        <label>
            Тип:
            <select id="obl_type_${obligationCount}">
                <option value="loan">loan</option>
                <option value="credit_card">credit_card</option>
                <option value="alimony">alimony</option>
                <option value="installment">installment</option>
            </select>
        </label>
        <label>
            Баланс:
            <input type="number" id="obl_balance_${obligationCount}" step="any">
        </label>
        <label>
            Ежемесячный платёж:
            <input type="number" id="obl_monthly_${obligationCount}" step="any">
        </label>
        <label>
            Минимальный платёж (%):
            <input type="number" id="obl_min_${obligationCount}" step="0.01">
        </label>
        <label>
            Название:
            <input type="text" id="obl_name_${obligationCount}">
        </label>
        <hr>
    `;
    container.appendChild(div);
}

document.getElementById('addObligationBtn').addEventListener('click', addObligation);

document.getElementById('pdnForm').addEventListener('submit', async function(e){
    e.preventDefault();

    // Собираем доход
    const income = {
        amount: parseFloat(document.getElementById('incomeAmount').value),
        currency: "RUB",
        income_type: "net",
        source: "salary"
    };

    // Собираем обязательства
    const obligations = [];
    for(let i=1; i<=obligationCount; i++){
        const type = document.getElementById(`obl_type_${i}`).value;
        const balance = parseFloat(document.getElementById(`obl_balance_${i}`).value) || undefined;
        const monthly_payment = parseFloat(document.getElementById(`obl_monthly_${i}`).value) || undefined;
        const min_payment_rate = parseFloat(document.getElementById(`obl_min_${i}`).value) || undefined;
        const name = document.getElementById(`obl_name_${i}`).value || undefined;

        obligations.push({type, balance, monthly_payment, min_payment_rate, name});
    }

    // Сценарий
    const scenario = {
        mode: document.getElementById('scenarioMode').value,
        income_shock_pct: parseFloat(document.getElementById('incomeShock').value),
        payment_shock_pct: parseFloat(document.getElementById('paymentShock').value)
    };

    const payload = {
        subject_type: "individual",
        period_months: parseInt(document.getElementById('periodMonths').value),
        income,
        obligations,
        scenario,
        meta: { client_id: "CLIENT123", calc_version: "v1.0" }
    };

    try {
        const res = await fetch("http://127.0.0.1:8000/pdn/calc", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();
        displayResult(data);

    } catch (err) {
        document.getElementById('result').innerText = "Ошибка запроса: " + err;
    }
});

function displayResult(data){
    if(data.error){
        document.getElementById('result').innerText = `Ошибка: ${data.error.message}`;
        return;
    }

    const d = data.data;
    let html = `<p><strong>PDN:</strong> ${d.pdn_percent}%</p>`;
    html += `<p><strong>Risk Band:</strong> <span class="risk-${d.risk_band}">${d.risk_band}</span></p>`;
    html += `<p><strong>Breakdown:</strong></p><ul>`;
    d.breakdown.forEach(b => html += `<li>${b.name}: ${b.monthly}</li>`);
    html += `</ul>`;
    document.getElementById('result').innerHTML = html;
}
</script>

</body>
</html>
