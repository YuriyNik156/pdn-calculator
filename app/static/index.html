<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>PDN Calculator MVP</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        label { display: block; margin-top: 10px; }
        input, select { margin-top: 2px; padding: 5px; width: 200px; }
        button { margin-top: 10px; padding: 5px 10px; }
        .obligation { margin-bottom: 5px; }
        .result { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
        .risk-LOW { color: green; }
        .risk-MID { color: orange; }
        .risk-HIGH { color: red; }
    </style>
</head>
<body>

<h2>PDN Calculator MVP</h2>

<form id="pdnForm">
    <h4>Доход</h4>
    <label>
        Сумма:
        <input type="number" id="incomeAmount" required min="0" step="any" value="100000">
    </label>
    <label>
        Валюта:
        <select id="incomeCurrency">
            <option value="RUB" selected>RUB</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
        </select>
    </label>
    <label>
        Тип дохода:
        <select id="incomeType">
            <option value="net" selected>net</option>
            <option value="gross">gross</option>
        </select>
    </label>
    <label>
        Источник:
        <select id="incomeSource">
            <option value="salary" selected>salary</option>
            <option value="business">business</option>
            <option value="other">other</option>
        </select>
    </label>

    <label>
        Период (месяцев):
        <input type="number" id="periodMonths" required min="1" value="6">
    </label>

    <div id="obligationsContainer">
        <h4>Обязательства</h4>
    </div>
    <button type="button" id="addObligationBtn">Добавить обязательство</button>

    <h4>Сценарий</h4>
    <label>
        Mode:
        <select id="scenarioMode">
            <option value="base">base</option>
            <option value="stress">stress</option>
            <option value="target">target</option>
        </select>
    </label>
    <label>
        Шок дохода (%):
        <input type="number" id="incomeShock" step="0.01" value="0">
    </label>
    <label>
        Шок платежей (%):
        <input type="number" id="paymentShock" step="0.01" value="0">
    </label>
    <label id="refinanceLabel" style="display:none;">
        Параметры рефинансирования (JSON):
        <input type="text" id="refinanceInput" placeholder='{"loan_id": "123", "new_monthly_payment": 20000}'>
    </label>

    <h4>Настройки (assumptions)</h4>
    <label>
        Минимальный платёж по кредитным картам (%):
        <input type="number" id="defaultMinPaymentRate" step="0.01" value="0.05">
    </label>
    <label>
        Округление денег:
        <input type="number" id="roundingMoney" value="2">
    </label>
    <label>
        Округление процентов:
        <input type="number" id="roundingPercent" value="2">
    </label>

    <button type="submit">Рассчитать PDN</button>
</form>

<div id="result" class="result"></div>

<script>
let obligationCount = 0;

// Показываем/скрываем поле refinance для target
document.getElementById('scenarioMode').addEventListener('change', function(){
    const label = document.getElementById('refinanceLabel');
    label.style.display = this.value === 'target' ? 'block' : 'none';
});

function addObligation() {
    obligationCount++;
    const container = document.getElementById('obligationsContainer');
    const div = document.createElement('div');
    div.className = 'obligation';
    div.innerHTML = `
        <label>
            Тип:
            <select id="obl_type_${obligationCount}">
                <option value="loan">loan</option>
                <option value="credit_card">credit_card</option>
                <option value="alimony">alimony</option>
                <option value="installment">installment</option>
            </select>
        </label>
        <label>
            Баланс:
            <input type="number" id="obl_balance_${obligationCount}" step="any">
        </label>
        <label>
            Ежемесячный платёж:
            <input type="number" id="obl_monthly_${obligationCount}" step="any">
        </label>
        <label>
            Минимальный платёж (%):
            <input type="number" id="obl_min_${obligationCount}" step="0.01">
        </label>
        <label>
            Название:
            <input type="text" id="obl_name_${obligationCount}">
        </label>
        <hr>
    `;
    container.appendChild(div);
}
document.getElementById('addObligationBtn').addEventListener('click', addObligation);

// Генерация UUID для meta.request_id
function generateUUID() {
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
}

document.getElementById('pdnForm').addEventListener('submit', async function(e){
    e.preventDefault();

    // Доход
    const income = {
        amount: parseFloat(document.getElementById('incomeAmount').value),
        currency: document.getElementById('incomeCurrency').value,
        income_type: document.getElementById('incomeType').value,
        source: document.getElementById('incomeSource').value
    };

    // Обязательства
    const obligations = [];
    for(let i=1; i<=obligationCount; i++){
        const type = document.getElementById(`obl_type_${i}`).value;
        const balance = parseFloat(document.getElementById(`obl_balance_${i}`).value) || undefined;
        const monthly_payment = parseFloat(document.getElementById(`obl_monthly_${i}`).value) || undefined;
        const min_payment_rate = parseFloat(document.getElementById(`obl_min_${i}`).value) || undefined;
        const name = document.getElementById(`obl_name_${i}`).value || undefined;

        obligations.push({type, balance, monthly_payment, min_payment_rate, name});
    }

    // Сценарий
    const refinanceRaw = document.getElementById('refinanceInput').value;
    const scenario = {
        mode: document.getElementById('scenarioMode').value,
        income_shock_pct: parseFloat(document.getElementById('incomeShock').value),
        payment_shock_pct: parseFloat(document.getElementById('paymentShock').value),
        refinance: refinanceRaw ? JSON.parse(refinanceRaw) : null
    };

    // Assumptions
    const assumptions = {
        credit_card_default_min_rate: parseFloat(document.getElementById('defaultMinPaymentRate').value),
        rounding: {
            money: parseInt(document.getElementById('roundingMoney').value),
            percent: parseInt(document.getElementById('roundingPercent').value)
        }
    };

    const payload = {
        subject_type: "individual",
        period_months: parseInt(document.getElementById('periodMonths').value),
        income,
        obligations,
        scenario,
        assumptions,
        meta: {
            client_id: "CLIENT123",
            request_id: generateUUID(),
            calc_version: "v1.0"
        }
    };

    try {
        const res = await fetch("http://127.0.0.1:8000/pdn/calc", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        displayResult(data);
    } catch (err) {
        document.getElementById('result').innerText = "Ошибка запроса: " + err;
    }
});

function displayResult(data){
    if(data.error){
        document.getElementById('result').innerText = `Ошибка: ${data.error.message}`;
        return;
    }

    const d = data.data;
    let html = `<p><strong>PDN:</strong> ${d.pdn_percent}%</p>`;
    html += `<p><strong>Risk Band:</strong> <span class="risk-${d.risk_band}">${d.risk_band}</span></p>`;
    html += `<p><strong>Breakdown:</strong></p><ul>`;
    d.breakdown.forEach(b => html += `<li>${b.name}: ${b.monthly}</li>`);
    html += `</ul>`;
    document.getElementById('result').innerHTML = html;
}
</script>

</body>
</html>
